<!DOCTYPE html>
<html>
<head>
  <title>Average Points Per Frame</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <header>
    <h1>Average Points Per Frame</h1>
  </header>

  <div id="chart" style="max-width: 900px; margin: auto; padding: 20px;"></div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQw8aR1Pkr3bqV9p7_OKcz55dVe2rQhwvgGc0AjNGlBn7oFPND4wTarjt9_N_GfnTVSA1snsieYYJ1o/pub?gid=0&single=true&output=csv";

    function updateChart() {
      fetch(csvUrl)
        .then(r => r.text())
        .then(csv => {
          const rows = csv.trim().split('\n');
          const header = rows[0].split(',');
          const dataRows = rows.slice(1);
          const idx = name => header.indexOf(name);

          const stats = {};

          dataRows.forEach(r => {
            const c = r.split(',');
            const p1 = c[idx('Player 1')], f1 = parseInt(c[idx('Frames 1')]), pts1 = parseInt(c[idx('Points 1')]);
            const p2 = c[idx('Player 2')], f2 = parseInt(c[idx('Frames 2')]), pts2 = parseInt(c[idx('Points 2')]);

            if (p1 && !isNaN(f1) && !isNaN(pts1)) {
              stats[p1] = stats[p1] || {frames:0, points:0};
              stats[p1].frames += f1;
              stats[p1].points += pts1;
            }
            if (p2 && !isNaN(f2) && !isNaN(pts2)) {
              stats[p2] = stats[p2] || {frames:0, points:0};
              stats[p2].frames += f2;
              stats[p2].points += pts2;
            }
          });

          const players = Object.keys(stats);
          const avgs = players.map(p => stats[p].frames === 0 ? 0 : stats[p].points / stats[p].frames);

          const sorted = players.map((p,i) => ({player:p,avg:avgs[i]}))
                                .sort((a,b) => b.avg - a.avg);

          const sortedP = sorted.map(x => x.player);
          const sortedA = sorted.map(x => x.avg);

          Plotly.newPlot('chart', [{
            x: sortedP,
            y: sortedA,
            type: 'bar',
            text: sortedA.map(a => a.toFixed(1)),
            textposition: 'outside',
            marker: {color: '#4CAF50'}
          }], {
            title: 'Average Points Per Frame',
            yaxis:{title:'Pts per Frame', rangemode:'tozero'},
            margin:{t:50}
          });
        });
    }

    updateChart();
    setInterval(updateChart, 30000); // refresh every 30s
  </script>
</body>
</html>
